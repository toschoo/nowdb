%% =======================================================
%% (c) 2021 Tobias Schoofs
%% =======================================================
%% Redesign Storage Engine
%% =======================================================

% Plain Style
\documentclass{scrartcl}

\include{cmds}

\usepackage{authblk}
\usepackage[toc,page]{appendix}
\usepackage{url}
\usepackage{hyperref}
\usepackage{algorithmic}
\usepackage{nicefrac}

\begin{document}
\setlength{\parindent}{0pt}
\setlength{\parskip}{8pt}

\title {Storage Engine Redesign}
\author {tobias.schoofs@gmx.net}
\date{\today}
\maketitle

\begin{itemize}
\item edges are pairs of (origin, dest)
\item remove concept of stamped edge
\item instead nodes can be stamped
\item nodes are stored exactly like edges today
\item for large nodes, the user needs to link together a group of nodes into one entity
\item ideas like column store come later
\item transactions
\item do we need distribution support on this level?
\end{itemize}

\begin{center}
\begingroup
\small
\renewcommand{\arraystretch}{1.5}
\begin{tabular}{|l|c|r|l|}\hline
attribute        & type   & size & comment\\\hline\hline
first stamp      & time   & 8    & \\\hline
last  stamp      & time   & 8    & \\\hline
compression size & uint32 & 4    & \\\hline
flags            & uint32 & 4    & \eg\ \emph{dirty}, \ie\ in tx\\\hline
deleted          & bitmap & var  & row at offset n is deleted\\\hline
locked           & bitmap & var  & row at offset n is locked\\\hline\hline
                 &        & 24+  & \\\hline
\end{tabular}
\captionof{table}{Page Header}\label{tab:pheader}
\endgroup
\end{center}

\begin{center}
\begingroup
\small
\renewcommand{\arraystretch}{1.5}
\begin{tabular}{|l|c|r|l|}\hline
attribute & type   & size & comment\\\hline\hline
type      & byte   & 1    & update or delete\\\hline
offset    & uint32 & 4    & offset into page\\\hline\hline
txpageid  & pageid & 8    & where the change is stored in the tx files\\\hline\hline
txoffset  & unit32 & 4    & where the change is stored in the tx files\\\hline\hline
          &        & 15   & \\\hline
\end{tabular}
\captionof{table}{Tx Descriptor}\label{tab:txdesc}
\endgroup
\end{center}

A transaction has an in-memory map that stores these nodes as
$pageid \rightarrow [tx\ desc]$. That is, each entry points
to a list of descriptors.

When we read a page, we check if the page is part of a tx (flags),
if so, we search the page in the map of our tx. If we don't find it,
we continue as normal.
Otherwise, for each offset in the list, we read the target txpageid+txoffset,
instead of the block or consider the deleted information of the tx desc.
In consequence, transactions with a lot of updates perform significantly
slower than otherwise, but transactions as such have no impact on performance.

For locks, if we find the corresponding pageid+offset, we ignore the lock
(it's ours). Otherwise, we need to wait until the lock is freed.

inserts are handled differently: a tx has it's own write buffers.
All inserts are written there and, after commit added to the normal buffers.
Note that a tx buffer that is not yet full can be used as normal buffer.
But it must be considered for queries!


\end{document}
